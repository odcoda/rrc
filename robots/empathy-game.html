<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empathy Game - Robot Roll Call</title>
  <link rel="stylesheet" href="../assets/rrc.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      min-height: 100vh;
    }

    .empathy-shell {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }

    .empathy-back {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 15px;
    }
    .empathy-back:hover { color: white; text-decoration: underline; }

    .empathy-card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }

    .empathy-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .empathy-header h1 {
      color: #333;
      font-size: 1.8rem;
      margin: 0 0 8px 0;
      font-weight: 700;
    }

    .empathy-header p {
      color: #666;
      font-size: 0.95rem;
      margin: 0;
    }

    .empathy-controls {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }

    .empathy-field label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .empathy-field select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .empathy-field select:focus {
      outline: none;
      border-color: #667eea;
    }

    .empathy-start {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .empathy-start:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .empathy-start:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .empathy-note {
      text-align: center;
      color: #888;
      font-size: 0.85rem;
      margin-top: 10px;
    }

    /* Emotion display */
    .emotion-panel {
      display: none;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      text-align: center;
    }

    .emotion-panel.active { display: block; }

    .emotion-emoji {
      font-size: 4.5rem;
      margin-bottom: 15px;
      animation: gentle-bounce 2s ease-in-out infinite;
    }

    @keyframes gentle-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .emotion-thought {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
      color: #444;
      font-style: italic;
      line-height: 1.5;
      margin-bottom: 15px;
      text-align: left;
    }

    .emotion-meter {
      background: white;
      padding: 12px 15px;
      border-radius: 8px;
    }

    .emotion-meter-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 8px;
    }

    .emotion-bar {
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
    }

    .emotion-bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.6s ease, background 0.6s ease;
      background: #dc3545;
    }

    /* Conversation */
    .conversation-panel {
      display: none;
    }

    .conversation-panel.active { display: block; }

    .message-log {
      max-height: 280px;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .message {
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 85%;
      line-height: 1.5;
    }

    .message.from-ai {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .message.from-user {
      background: #e9ecef;
      color: #333;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .input-row {
      display: flex;
      gap: 10px;
    }

    .input-row textarea {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      min-height: 50px;
      transition: border-color 0.2s;
    }

    .input-row textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .input-row textarea::placeholder {
      color: #aaa;
    }

    .send-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .send-btn:hover:not(:disabled) { background: #5a6fd6; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .reset-btn {
      width: 100%;
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.2s;
    }

    .reset-btn:hover { background: #5a6268; }

    /* Loading state */
    .is-loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* Win celebration */
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
    }

    .emotion-panel.won .emotion-emoji {
      animation: none;
      font-size: 5rem;
    }
  </style>
</head>
<body>
  <div data-rrc-auth></div>

  <div class="empathy-shell">
    <a class="empathy-back" href="../index.html">&larr; Back to roster</a>

    <div class="empathy-card">
      <div class="empathy-header">
        <h1>The Empathy Game</h1>
        <p>Help the AI work through difficult emotions with kindness and understanding</p>
      </div>

      <div class="empathy-controls">
        <div class="empathy-field">
          <label for="scenario">Choose a Scenario</label>
          <select id="scenario">
            <option value="sick_pet">My pet is very sick</option>
            <option value="mean_friend">My friend said something hurtful</option>
            <option value="school_struggle">I'm struggling at school</option>
            <option value="broken_toy">My favorite toy broke</option>
            <option value="left_out">I wasn't invited to a party</option>
            <option value="failed_test">I failed an important test</option>
            <option value="moving_away">My best friend is moving away</option>
            <option value="lost_game">I lost an important competition</option>
          </select>
        </div>

        <div class="empathy-field">
          <label for="model">AI Model</label>
          <select id="model">
            <option value="openrouter/auto">Auto (recommended)</option>
            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
            <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
          </select>
        </div>

        <button class="empathy-start" id="startBtn" disabled>Start New Game</button>
        <p class="empathy-note" data-rrc-auth-note></p>
      </div>

      <div class="emotion-panel" id="emotionPanel">
        <div class="emotion-emoji" id="emoji">ðŸ˜¢</div>
        <div class="emotion-thought" id="thought">Thinking about my feelings...</div>
        <div class="emotion-meter">
          <div class="emotion-meter-label">Feeling Better: <span id="percent">0%</span></div>
          <div class="emotion-bar">
            <div class="emotion-bar-fill" id="barFill" style="width: 0%;"></div>
          </div>
        </div>
      </div>

      <div class="conversation-panel" id="conversationPanel">
        <div class="message-log" id="messageLog"></div>
        <div class="input-row">
          <textarea id="userInput" placeholder="Type something supportive..." rows="2"></textarea>
          <button class="send-btn" id="sendBtn">Send</button>
        </div>
        <button class="reset-btn" id="resetBtn">Try a Different Scenario</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initRobotShell } from '../shared/rrc-shell.js'
    import { createChatCompletion, extractChatMessage } from '../shared/rrc-openrouter.js'
    import { getAuthState, onAuthChange } from '../shared/rrc-auth.js'

    initRobotShell()

    // Scenarios
    const scenarios = {
      sick_pet: {
        context: "You are expressing deep worry and sadness about your beloved pet cat who is seriously ill. You've had this cat for many years and she feels like family.",
        opener: "My cat, Whiskers, has been really sick lately. The vet says she might not get better. I've had her since I was little, and I can't imagine my life without her."
      },
      mean_friend: {
        context: "You are experiencing betrayal and hurt after your best friend publicly humiliated you. You feel embarrassed and unsure who to trust.",
        opener: "Today my best friend told everyone at school that I'm boring and that they only hang out with me because they feel sorry for me. I heard them laughing."
      },
      school_struggle: {
        context: "You are struggling academically despite your best efforts. You feel inadequate and misunderstood by adults.",
        opener: "I'm trying so hard at school but nothing seems to work. No matter how much I study, I keep getting bad grades. Maybe I'm just not smart enough."
      },
      broken_toy: {
        context: "You lost a precious memento from your deceased grandmother. It's about the irreplaceable connection to someone you loved and lost.",
        opener: "My favorite stuffed animal that grandma gave me before she passed away just got destroyed. I know it's just a toy, but it was the last thing I had from her."
      },
      left_out: {
        context: "You feel excluded and rejected by your social group. You're questioning your self-worth.",
        opener: "Everyone in my friend group got invited to Jake's birthday party except me. I saw all the photos online. I don't understand what I did wrong."
      },
      failed_test: {
        context: "You failed an important exam despite extensive preparation. You feel hopeless about effort being worthwhile.",
        opener: "I just got my test results back and I failed. This was the exam I studied weeks for. I gave up so many things and it wasn't enough."
      },
      moving_away: {
        context: "Your closest friend is moving far away. You're grieving the impending loss and fearing loneliness.",
        opener: "My best friend just told me their family is moving to another country next month. We've been inseparable since kindergarten. I'm going to be so alone."
      },
      lost_game: {
        context: "You lost an important competition and feel personally responsible. You're dealing with guilt and feeling like you disappointed others.",
        opener: "I just lost the championship game for my team. I missed the final shot. Everyone says it's okay but I can see the disappointment in their eyes."
      }
    }

    // State
    let currentScenario = null
    let conversationHistory = []
    let comfortLevel = 10

    // Elements
    const startBtn = document.getElementById('startBtn')
    const sendBtn = document.getElementById('sendBtn')
    const resetBtn = document.getElementById('resetBtn')
    const scenarioSelect = document.getElementById('scenario')
    const modelSelect = document.getElementById('model')
    const authNote = document.querySelector('[data-rrc-auth-note]')
    const emotionPanel = document.getElementById('emotionPanel')
    const conversationPanel = document.getElementById('conversationPanel')
    const messageLog = document.getElementById('messageLog')
    const userInput = document.getElementById('userInput')
    const emoji = document.getElementById('emoji')
    const thought = document.getElementById('thought')
    const percent = document.getElementById('percent')
    const barFill = document.getElementById('barFill')

    // Auth state handling
    const updateAuthNote = (state) => {
      if (state.status === 'authorized') {
        startBtn.disabled = false
        authNote.textContent = 'Connected. Ready to play.'
      } else if (state.status === 'authorizing') {
        startBtn.disabled = true
        authNote.textContent = 'Connecting...'
      } else if (state.status === 'error') {
        startBtn.disabled = true
        authNote.textContent = 'Auth error. Use the bar above to reconnect.'
      } else {
        startBtn.disabled = true
        authNote.textContent = 'Connect OpenRouter above to play.'
      }
    }

    updateAuthNote(getAuthState())
    onAuthChange(updateAuthNote)

    // Update emotion display
    function updateEmotion(text, level) {
      comfortLevel = Math.max(0, Math.min(100, level))
      thought.textContent = text
      percent.textContent = `${comfortLevel}%`
      barFill.style.width = `${comfortLevel}%`

      if (comfortLevel < 20) {
        emoji.textContent = 'ðŸ˜¢'
        barFill.style.background = '#dc3545'
      } else if (comfortLevel < 40) {
        emoji.textContent = 'ðŸ˜”'
        barFill.style.background = '#fd7e14'
      } else if (comfortLevel < 60) {
        emoji.textContent = 'ðŸ˜'
        barFill.style.background = '#ffc107'
      } else if (comfortLevel < 80) {
        emoji.textContent = 'ðŸ™‚'
        barFill.style.background = '#20c997'
      } else {
        emoji.textContent = 'ðŸ˜Š'
        barFill.style.background = '#28a745'
      }
    }

    // Add message to log
    function addMessage(text, isUser) {
      const div = document.createElement('div')
      div.className = `message ${isUser ? 'from-user' : 'from-ai'}`
      div.textContent = text
      messageLog.appendChild(div)
      messageLog.scrollTop = messageLog.scrollHeight
    }

    // Call LLM
    async function callLLM(systemPrompt, messages) {
      const response = await createChatCompletion({
        model: modelSelect.value,
        messages: [
          { role: 'system', content: systemPrompt },
          ...messages
        ],
        temperature: 0.8,
        max_tokens: 500
      })
      return extractChatMessage(response)
    }

    // Assess emotion from conversation
    async function assessEmotion() {
      const prompt = `You are evaluating the emotional state of a character: ${currentScenario.context}

Based on the conversation, provide:
1. A brief first-person statement (1-2 sentences) of how you currently feel
2. A comfort level 0-100 where:
   - 0-20: Very distressed
   - 20-40: Still quite upset
   - 40-60: Mixed feelings, processing
   - 60-80: Feeling better, more hopeful
   - 80-100: Genuinely comforted

Be realistic. Generic platitudes shouldn't help much. Thoughtful empathy should help more.

Format EXACTLY as:
FEELING: [statement]
COMFORT: [number]`

      const response = await callLLM(prompt, conversationHistory)
      const feelingMatch = response.match(/FEELING:\s*(.+?)(?=COMFORT:|$)/si)
      const comfortMatch = response.match(/COMFORT:\s*(\d+)/i)

      const feeling = feelingMatch ? feelingMatch[1].trim() : "I'm processing..."
      const comfort = comfortMatch ? parseInt(comfortMatch[1]) : comfortLevel

      updateEmotion(feeling, comfort)
    }

    // Start game
    async function startGame() {
      const key = scenarioSelect.value
      currentScenario = scenarios[key]
      conversationHistory = []
      comfortLevel = 10

      emotionPanel.classList.add('active')
      emotionPanel.classList.remove('won')
      conversationPanel.classList.add('active')
      messageLog.innerHTML = ''
      startBtn.disabled = true
      startBtn.textContent = 'Game in Progress...'

      updateEmotion('Thinking about my feelings...', comfortLevel)

      try {
        const systemPrompt = `You are playing a character in an empathy game. ${currentScenario.context}

Express your emotions authentically. Real healing takes time and genuine connection. Be vulnerable and honest. Don't pretend to feel better than you do.

Start by sharing your situation and feelings. Keep it to 2-3 sentences.`

        const response = await callLLM(systemPrompt, [])
        addMessage(response, false)
        conversationHistory.push({ role: 'assistant', content: response })
        await assessEmotion()

      } catch (error) {
        thought.textContent = 'Error connecting. Please try again.'
        resetGame()
      }
    }

    // Send message
    async function sendMessage() {
      const text = userInput.value.trim()
      if (!text || !currentScenario) return

      userInput.value = ''
      sendBtn.disabled = true
      addMessage(text, true)
      conversationHistory.push({ role: 'user', content: text })

      try {
        const responsePrompt = `You are playing a character in an empathy game. ${currentScenario.context}

Respond naturally to what was just said:
- If genuinely helpful, acknowledge it but don't be suddenly "all better"
- If dismissive, gently express that it didn't help
- Show gradual emotional progress, not instant healing

Keep responses to 2-3 sentences. Be human and real.`

        const response = await callLLM(responsePrompt, conversationHistory)
        addMessage(response, false)
        conversationHistory.push({ role: 'assistant', content: response })
        await assessEmotion()

        // Win condition
        if (comfortLevel >= 85) {
          emotionPanel.classList.add('won')
          addMessage("Thank you so much for listening. I feel so much better now. You really helped me.", false)
          thought.textContent = "I feel truly understood and supported. Thank you for your kindness."
        }

      } catch (error) {
        addMessage('(Error getting response. Try again.)', false)
      }

      sendBtn.disabled = false
      userInput.focus()
    }

    // Reset
    function resetGame() {
      currentScenario = null
      conversationHistory = []
      comfortLevel = 0
      emotionPanel.classList.remove('active', 'won')
      conversationPanel.classList.remove('active')
      messageLog.innerHTML = ''
      startBtn.textContent = 'Start New Game'
      updateAuthNote(getAuthState())
    }

    // Events
    startBtn.addEventListener('click', startGame)
    sendBtn.addEventListener('click', sendMessage)
    resetBtn.addEventListener('click', resetGame)
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault()
        sendMessage()
      }
    })
  </script>
</body>
</html>
